@page "/"
@inject ISpeechService SpeechService
@inject IJSRuntime JS
@using Microsoft.Maui.ApplicationModel
@using VoiceRecognition.Abstractions
@namespace VoiceRecognition.Components.Pages

<div class="assistant-wrapper">
    <div class="assistant-container @(SpeechService.IsListening ? "active" : "")">
        <h3>Voice Recognition</h3>
        <div class="status">@status</div>

        <button class="mic-button @(SpeechService.IsListening ? "listening" : "")"
                @onclick="ToggleListening">
            <span>@(SpeechService.IsListening ? "🛑" : "🎤")</span>
        </button>

        <div class="waveform">
            <div class="bar" style="height:@BarHeights[0]px"></div>
            <div class="bar" style="height:@BarHeights[1]px"></div>
            <div class="bar" style="height:@BarHeights[2]px"></div>
            <div class="bar" style="height:@BarHeights[3]px"></div>
            <div class="bar" style="height:@BarHeights[4]px"></div>
        </div>
    </div>
</div>
@if (showProtocolOverlay)
{
    <div class="protocol-overlay" style="position: absolute; top:0; left:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; background-color:rgba(0,0,0,0.5);">
        <img src="images/tony.jpg" alt="Jarvis Activation" style="width:max-content;height:max-content;" />
        <div class="protocol-text" style="position:absolute; bottom:20px; color:white;">Protocol Activated</div>
    </div>
}

<!-- HTML audio элемент (в BlazorWebView это будет локальный файл из wwwroot) -->
<audio id="activateAudio" src="sounds/fart-with-reverb.mp3" preload="auto"></audio>
<script src="js/site.js"></script>
@code {
    string recognizedText = "";
    string status = "Скажи что-нибудь…";
    bool showProtocolOverlay = false;
    int[] BarHeights = new int[5];

    protected override void OnInitialized()
    {
        SpeechService.PartialResult += s =>
        {
            recognizedText = s;
            InvokeAsync(StateHasChanged);
        };

        SpeechService.FinalResult += async s =>
        {
            recognizedText = s;
            status = "Готово";
            await InvokeAsync(StateHasChanged);
            await SearchInBrowser();
        };

        // Подписка на VolumeChanged
        SpeechService.VolumeChanged += vol =>
        {
            for (int i = 0; i < BarHeights.Length; i++)
                BarHeights[i] = 10 + (int)(vol * 5 * (i + 1) / BarHeights.Length); // масштабируем полоски
            InvokeAsync(StateHasChanged);
        };
    }

    async Task ToggleListening()
    {
        if (!SpeechService.IsListening)
        {
            status = "Слушаю…";
            recognizedText = "";
            await SpeechService.StartListeningAsync();
        }
        else
        {
            await SpeechService.StopListeningAsync();
            status = "Останавливаю…";
            await SearchInBrowser();
            status = "Скажи что-нибудь…";
        }

        StateHasChanged();
    }

    async Task SearchInBrowser()
    {
        if (string.IsNullOrWhiteSpace(recognizedText)) return;
        if (recognizedText.Contains("Джарвис") && recognizedText.Contains("активировать") && recognizedText.Contains("протокол"))
        {
            await ActivateProtocolEffect();
        }
        else
        {
            var q = Uri.EscapeDataString(recognizedText);
            var url = $"https://www.google.com/search?q={q}";
            await Launcher.OpenAsync(new Uri(url));
        }
    }

    async Task ActivateProtocolEffect()
    {
        showProtocolOverlay = true;
        await InvokeAsync(StateHasChanged);

        // Вызов JS функции, которая проиграет <audio>
        await JS.InvokeVoidAsync("playActivationSound");

        // Показать 3 секунды
        await Task.Delay(3000);

        showProtocolOverlay = false;
        await InvokeAsync(StateHasChanged);
    }
}

